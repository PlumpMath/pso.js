<!DOCTYPE html>

<html>
<head>
  <title>pso.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pso.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Copyright <span class="hljs-number">2015</span> Adrian Toncean; released under the MIT license
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="hljs-pi">	'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Defines a candidate solution</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Particle</span><span class="hljs-params">(position, velocity, inertiaWeight, social, personal)</span> </span>{
		<span class="hljs-keyword">this</span>.position = position;
		<span class="hljs-keyword">this</span>.velocity = velocity;
		<span class="hljs-keyword">this</span>.bestPosition = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-keyword">this</span>.position.length);
		<span class="hljs-keyword">this</span>.fitness = -<span class="hljs-literal">Infinity</span>;
		<span class="hljs-keyword">this</span>.bestFitness = -<span class="hljs-literal">Infinity</span>;
	 
		<span class="hljs-keyword">this</span>.inertiaWeight = inertiaWeight;
		<span class="hljs-keyword">this</span>.social = social;
		<span class="hljs-keyword">this</span>.personal = personal;
	}
	
	Particle.prototype = {
		storePosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.position.length; i++) {
				<span class="hljs-keyword">this</span>.bestPosition[i] = <span class="hljs-keyword">this</span>.position[i];
			}
		},
	
		getPosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> ret = [];
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.position.length; i++) {
				ret.push(<span class="hljs-keyword">this</span>.position[i]);
			}
			<span class="hljs-keyword">return</span> ret;
		},
		
		getBestPosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> ret = [];
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.position.length; i++) {
				ret.push(<span class="hljs-keyword">this</span>.bestPosition[i]);
			}
			<span class="hljs-keyword">return</span> ret;
		},
	
		updateVelocity: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(globalBest)</span> </span>{
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.position.length; i++) {
				<span class="hljs-keyword">this</span>.velocity[i] = <span class="hljs-keyword">this</span>.velocity[i] * <span class="hljs-keyword">this</span>.inertiaWeight + 
					(globalBest.position[i] - <span class="hljs-keyword">this</span>.position[i]) * <span class="hljs-built_in">Math</span>.random() * <span class="hljs-keyword">this</span>.social + 
					(<span class="hljs-keyword">this</span>.bestPosition[i] - <span class="hljs-keyword">this</span>.position[i]) * <span class="hljs-built_in">Math</span>.random() * <span class="hljs-keyword">this</span>.personal;
			}
		},
	
		updatePosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.position.length; i++) {
				<span class="hljs-keyword">this</span>.position[i] += <span class="hljs-keyword">this</span>.velocity[i];
			}
		}
	};
	
	Particle.createRandom = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(domain, options, velocityMultiplier)</span> </span>{
		velocityMultiplier = <span class="hljs-keyword">typeof</span> velocityMultiplier === <span class="hljs-string">'undefined'</span> ? <span class="hljs-number">0.1</span> : velocityMultiplier;
		<span class="hljs-keyword">var</span> position = [];
		<span class="hljs-keyword">var</span> velocity = [];
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; domain.length; i++) {
			position.push(<span class="hljs-built_in">Math</span>.random() * (domain[i].end - domain[i].start) + domain[i].start);
			velocity.push((<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>) * velocityMultiplier);
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Particle(position, velocity, options.inertiaWeight, options.social, options.personal);
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Used to define domains.
An <em>Interval</em> is anything with a <em>start</em> and an <em>end</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Interval</span><span class="hljs-params">(start, end)</span> </span>{
		<span class="hljs-keyword">this</span>.start = start;
		<span class="hljs-keyword">this</span>.end = end;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Holds particles and carries out the optimization task.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Optimizer</span><span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">this</span>.particles = <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">this</span>.objectiveFunction = <span class="hljs-literal">null</span>;
		
		<span class="hljs-keyword">this</span>.bestPositionEver = <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">this</span>.bestFitnessEver = -<span class="hljs-literal">Infinity</span>;
		<span class="hljs-keyword">this</span>.iteration = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">this</span>.pressure = <span class="hljs-number">0.5</span>;
	 
		<span class="hljs-keyword">this</span>.options = {
			inertiaWeight: <span class="hljs-number">0.8</span>,
			social: <span class="hljs-number">0.4</span>,
			personal: <span class="hljs-number">0.4</span>
		};

		<span class="hljs-keyword">this</span>.async = <span class="hljs-literal">false</span>;
		<span class="hljs-keyword">this</span>._waiting = <span class="hljs-literal">false</span>;
	}

	Optimizer.prototype = {
		setOptions: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> </span>{
			options = options || {};
			<span class="hljs-keyword">if</span> (options.inertiaWeight !== <span class="hljs-literal">undefined</span>) {
				<span class="hljs-keyword">this</span>.options.inertiaWeight = options.inertiaWeight;
			}
			<span class="hljs-keyword">if</span> (options.social !== <span class="hljs-literal">undefined</span>) {
				<span class="hljs-keyword">this</span>.options.social = options.social;
			}
			<span class="hljs-keyword">if</span> (options.personal !== <span class="hljs-literal">undefined</span>) {
				<span class="hljs-keyword">this</span>.options.personal = options.personal;
			}
		},
		
		setObjectiveFunction: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(objectiveFunction, options)</span> </span>{
			<span class="hljs-keyword">this</span>.objectiveFunction = objectiveFunction;
			<span class="hljs-keyword">this</span>.async = options &amp;&amp; options.async;
		},
		
		init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(nParticles, generationOption)</span> </span>{
			<span class="hljs-keyword">var</span> generator = generationOption <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span> ?
				<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> generationOption(); } :
				<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					<span class="hljs-keyword">return</span> Particle.createRandom(generationOption, <span class="hljs-keyword">this</span>.options);
				}.bind(<span class="hljs-keyword">this</span>);
			
			<span class="hljs-keyword">this</span>.iteration = <span class="hljs-number">0</span>;
			<span class="hljs-keyword">this</span>.bestPositionEver = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">this</span>.bestFitnessEver = -<span class="hljs-literal">Infinity</span>;
			
			<span class="hljs-keyword">this</span>.particles = [];
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; nParticles; i++) {
				<span class="hljs-keyword">this</span>.particles.push(generator());
			}
		},
	
		getRandomBest: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(except)</span> </span>{
			<span class="hljs-keyword">var</span> ret = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-keyword">this</span>.particles.length);
			
			<span class="hljs-keyword">this</span>.particles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle, index)</span> </span>{
				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.random() &lt; <span class="hljs-keyword">this</span>.pressure &amp;&amp;
					<span class="hljs-keyword">this</span>.particles[index].fitness &gt; <span class="hljs-keyword">this</span>.particles[ret].fitness &amp;&amp; 
					index !== except) {
					ret = index;
				}
			}.bind(<span class="hljs-keyword">this</span>));
			
			<span class="hljs-keyword">return</span> ret;
		},

		step: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> </span>{
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.async) {
				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._waiting) {
					<span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'Cannot step again before previous requests have been completed!'</span>);
					<span class="hljs-keyword">return</span>;
				}
				<span class="hljs-keyword">this</span>._waiting = <span class="hljs-literal">true</span>;
				<span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
				<span class="hljs-keyword">var</span> optimizer = <span class="hljs-keyword">this</span>;
				<span class="hljs-keyword">this</span>.particles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle)</span> </span>{
					optimizer.objectiveFunction(particle.position, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fitness)</span> </span>{
						particle.fitness = fitness;
						completed++;
						<span class="hljs-keyword">if</span> (completed &gt;= optimizer.particles.length) {
							optimizer._waiting = <span class="hljs-literal">false</span>;
							optimizer._completeStep();
							callback();
						}
					});
				});
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">this</span>.particles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle)</span> </span>{
					particle.fitness = <span class="hljs-keyword">this</span>.objectiveFunction(particle.position);
				}.bind(<span class="hljs-keyword">this</span>));
				<span class="hljs-keyword">this</span>._completeStep();
			}
		},

		_completeStep: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">this</span>.particles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle)</span> </span>{
				<span class="hljs-keyword">if</span> (particle.fitness &gt; particle.bestFitness) {
					particle.bestFitness = particle.fitness;
					particle.storePosition();
		
					<span class="hljs-keyword">if</span> (particle.fitness &gt; <span class="hljs-keyword">this</span>.bestFitnessEver) {
						<span class="hljs-keyword">this</span>.bestFitnessEver = particle.fitness;
						<span class="hljs-keyword">this</span>.bestPositionEver = particle.getPosition();
					}
				}
			}.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>update velocities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">this</span>.particles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle, index)</span> </span>{
				<span class="hljs-keyword">var</span> randomBest = <span class="hljs-keyword">this</span>.particles[<span class="hljs-keyword">this</span>.getRandomBest(index)];
				particle.updateVelocity(randomBest);
			}.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>update positions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">this</span>.particles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle)</span> </span>{
				particle.updatePosition();
			});
			
			<span class="hljs-keyword">this</span>.iteration++;
		},
	
		getParticles: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.particles.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle)</span> </span>{
				<span class="hljs-keyword">return</span> particle.getPosition();
			});
		},
		
		getParticlesBest: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.particles.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle)</span> </span>{
				<span class="hljs-keyword">return</span> particle.getBestPosition();
			});
		},
	
		getBestPosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bestPositionEver;
		},
	
		getBestFitness: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bestFitnessEver;
		},
	
		getMeanFitness: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>;
			<span class="hljs-keyword">this</span>.particles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(particle)</span> </span>{
				sum += particle.fitness;
			});
			<span class="hljs-keyword">return</span> sum / <span class="hljs-keyword">this</span>.particles.length;
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
		define(<span class="hljs-string">'pso/Interval'</span>, [], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> Interval; });
		define(<span class="hljs-string">'pso/Particle'</span>, [], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> Particle; });
		define(<span class="hljs-string">'pso/Optimizer'</span>, [], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> Optimizer; });
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> WorkerGlobalScope !== <span class="hljs-string">'undefined'</span> &amp;&amp; self <span class="hljs-keyword">instanceof</span> WorkerGlobalScope) {
		self.pso = {
			Interval: Interval,
			Particle: Particle,
			Optimizer: Optimizer
		};
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-built_in">window</span>.pso = {
			Interval: Interval,
			Particle: Particle,
			Optimizer: Optimizer
		};
	}
})();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
